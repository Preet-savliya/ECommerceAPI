<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Products - Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; color: #1e293b; }
        .navbar { background-color: rgba(255, 255, 255, 0.9) !important; backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; padding: 12px 0; }
        .navbar-brand { color: #2563eb !important; font-weight: 700; }
        .inventory-header { background: white; padding: 24px 28px; border: 1px solid #e2e8f0; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .table-container { background: white; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); overflow: hidden; }
        .table thead th { background-color: #f8fafc; color: #475569; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; padding: 16px 20px; border: 1px solid #c8c8c8; }
        .table tbody td { padding: 16px 20px; vertical-align: middle; border: 1px solid #c8c8c8; }
        .btn-logout { background-color: #fff1f2; color: #e11d48; border: 1px solid #ffe4e6; font-weight: 600; border-radius: 8px; }
        #successMessage { display: none; position: fixed; top: 90px; right: 20px; z-index: 10000; border-radius: 8px; background-color: #059669; color: white; padding: 12px 24px; font-weight: 500; }
        .badge-stock { padding: 6px 12px; border-radius: 50px; font-weight: 600; font-size: 0.75rem; }
        #adminActions { display: none; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fa-solid fa-box-open me-2"></i>ERP System</a>
            <div class="collapse navbar-collapse justify-content-center">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="product.html">Products</a></li>
                    <li class="nav-item"><a class="nav-link" href="order.html">Orders</a></li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="px-3 py-1 bg-white rounded-pill border shadow-sm d-flex align-items-center">
                    <i class="fa-regular fa-circle-user me-2 text-primary"></i>
                    <span class="text-dark small fw-bold" id="profileName"></span>
                </div>
                <button class="btn btn-logout btn-sm px-3" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <div id="successMessage" class="alert alert-success shadow">Action successful!</div>

    <div class="container-fluid p-4">
        <div class="inventory-header d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
            <div>
                <h3 class="fw-bold mb-0 text-dark">Inventory Management</h3>
                <p class="text-muted small mb-0">Prices automatically update based on the set GST percentage.</p>
            </div>
            <div id="adminActions" class="gap-2">
                <button class="btn btn-primary px-4 rounded-3 fw-500" data-bs-toggle="modal" data-bs-target="#addProductModal" onclick="fetchCategoriesForSelect('newCategorySelect')">
                    <i class="bi bi-plus-lg me-2"></i>Add Product
                </button>
                <button class="btn btn-success px-4 rounded-3 fw-500" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                    <i class="bi bi-tag me-2"></i>Add Category
                </button>
            </div>
        </div>

        <div class="table-container">
            <div id="productContent" class="table-responsive"></div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white p-4">
                    <h5 class="modal-title fw-bold">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addProductForm">
                        <div class="mb-3"><label class="form-label fw-bold small text-muted">Product Name</label><input type="text" id="newName" class="form-control" required></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">Price (Base ₹)</label><input type="number" step="0.01" id="newPrice" class="form-control" required></div>
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">GST (%)</label><input type="number" id="newGst" class="form-control" value="18" required></div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">Stock</label><input type="number" id="newStock" class="form-control" required></div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold small text-muted">Category</label>
                                <select id="newCategorySelect" class="form-select" required></select>
                            </div>
                        </div>
                        <div class="mb-3"><label class="form-label fw-bold small text-muted">Description</label><textarea id="newDescription" class="form-control" rows="2" required></textarea></div>
                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Save Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning p-4">
                    <h5 class="modal-title fw-bold">Edit Product & Tax</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3"><label class="form-label fw-bold small text-muted">Product Name</label><input type="text" id="editName" class="form-control" required></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">Base Price (₹)</label><input type="number" step="0.01" id="editPrice" class="form-control" required></div>
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">GST (%)</label><input type="number" id="editGst" class="form-control" required></div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label fw-bold small text-muted">Stock</label><input type="number" id="editStock" class="form-control" required></div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold small text-muted">Category</label>
                                <select id="editCategorySelect" class="form-select" required></select>
                            </div>
                        </div>
                        <div class="mb-3"><label class="form-label fw-bold small text-muted">Description</label><textarea id="editDescription" class="form-control" required></textarea></div>
                        <button type="submit" class="btn btn-warning w-100 py-2 fw-bold text-dark">Update Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="buyProductModal" tabindex="-1" aria-hidden="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white p-4">
                    <h5 class="modal-title fw-bold">Confirm Purchase</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="buyProductForm">
                        <input type="hidden" id="buyProductId"><input type="hidden" id="buyProductPrice"><input type="hidden" id="buyProductGstRate">
                        <div class="mb-3 d-flex justify-content-between">
                            <h5 id="buyProductName" class="fw-bold text-dark"></h5>
                            <span class="badge bg-danger rounded-pill">Stock: <span id="buyProductStockDisplay">0</span></span>
                        </div>
                        <div class="mb-3"><label class="form-label small fw-bold">Quantity</label><input type="number" id="buyQuantity" class="form-control" value="1" min="1" required></div>
                        <div class="mb-3"><label class="form-label small fw-bold">Shipping Address</label><textarea id="buyAddress" class="form-control" rows="2" required></textarea></div>
                        <div class="bg-light p-3 rounded-3 mb-3">
                            <div class="d-flex justify-content-between small text-muted mb-1"><span>Base:</span><span id="buyBasePrice">₹0.00</span></div>
                            <div class="d-flex justify-content-between small text-muted mb-2"><span>GST (<span id="buyGstPercentDisplay">0</span>%):</span><span id="buyGstAmount">₹0.00</span></div>
                            <div class="d-flex justify-content-between align-items-center"><h6 class="mb-0 fw-bold">Total:</h6><h4 id="buyTotalPrice" class="text-success fw-bold mb-0">₹0.00</h4></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold">Place Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://localhost:5112/api/products";
        const CAT_API_URL = "http://localhost:5112/api/categories";
        const ORDER_API_URL = "http://localhost:5112/api/orders";

        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser) { window.location.href = "index.html"; }
        else { 
            document.getElementById("profileName").innerText = loggedInUser.email;
            document.getElementById('adminActions').style.display = (loggedInUser.role === 'admin') ? 'flex' : 'none';
        }

        document.getElementById("logoutBtn").addEventListener("click", () => { localStorage.removeItem("loggedInUser"); window.location.href = "index.html"; });

        async function fetchCategoriesForSelect(selectId, selectedId = null) {
            try {
                const res = await fetch(CAT_API_URL);
                const data = await res.json();
                const categories = data.$values || data;
                let options = '<option value="">Select Category</option>';
                categories.forEach(c => options += `<option value="${c.categoryId}" ${c.categoryId == selectedId ? 'selected' : ''}>${c.name}</option>`);
                document.getElementById(selectId).innerHTML = options;
            } catch (err) { console.error(err); }
        }

        async function loadProducts() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const products = data.$values || data;
                const isAdmin = loggedInUser.role === 'admin';

                let html = `<table class="table align-middle mb-0">
                    <thead><tr><th>Product Name</th><th>Description</th><th>Price (Incl. GST)</th><th>Category</th>${isAdmin ? '<th>Stock</th>' : ''}<th class="text-end">${isAdmin ? 'Actions' : 'Purchase'}</th></tr></thead><tbody>`;

                products.forEach(p => {
                    const gstRate = p.gst || 18; 
                    const basePrice = parseFloat(p.price);
                    const totalPrice = basePrice + (basePrice * (gstRate / 100));

                    html += `<tr>
                        <td><span class="fw-bold text-dark">${p.name}</span></td>
                        <td><small class="text-muted">${p.description}</small></td>
                        <td>
                            <div class="fw-bold text-primary">₹${totalPrice.toFixed(2)}</div>
                            <div class="text-muted" style="font-size: 0.7rem;">Base: ₹${basePrice.toFixed(2)} | Tax: ${gstRate}%</div>
                        </td>
                        <td><span class="badge bg-white text-dark border">${p.categoryName || 'N/A'}</span></td>
                        ${isAdmin ? `<td><span class="badge-stock ${p.stock < 10 ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'}">${p.stock} units</span></td>` : ''} 
                        <td class="text-end">
                            ${isAdmin ? `
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal(${p.productId}, '${p.name.replace(/'/g, "\\'")}', '${(p.description || "").replace(/'/g, "\\'")}', ${p.price}, ${p.stock}, ${p.categoryId}, ${gstRate})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.productId})"><i class="bi bi-trash"></i></button>
                            ` : `
                                <button class="btn btn-sm btn-success px-4 rounded-pill" onclick="openBuyModal(${p.productId}, '${p.name.replace(/'/g, "\\'")}', '${(p.description || "").replace(/'/g, "\\'")}', ${p.price}, ${p.stock}, ${gstRate})">Buy Now</button>
                            `}
                        </td>
                    </tr>`;
                });
                document.getElementById("productContent").innerHTML = html + "</tbody></table>";
            } catch (err) { console.error(err); }
        }

        function openEditModal(id, name, desc, price, stock, catId, gst) {
            document.getElementById('editProductId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editDescription').value = desc;
            document.getElementById('editPrice').value = price;
            document.getElementById('editStock').value = stock;
            document.getElementById('editGst').value = gst;
            fetchCategoriesForSelect('editCategorySelect', catId);
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }

        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editProductId').value;
            const product = {
                productId: parseInt(id),
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                price: parseFloat(document.getElementById('editPrice').value),
                gst: parseFloat(document.getElementById('editGst').value), // Dynamic GST saved here
                stock: parseInt(document.getElementById('editStock').value),
                categoryId: parseInt(document.getElementById('editCategorySelect').value)
            };
            const res = await fetch(`${API_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", "UserRole": loggedInUser.role },
                body: JSON.stringify(product)
            });
            if (res.ok) { showStatus("Product & Price Updated!"); loadProducts(); bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide(); }
        });

        function openBuyModal(id, name, desc, price, stock, gst) {
            document.getElementById('buyProductId').value = id;
            document.getElementById('buyProductPrice').value = price; 
            document.getElementById('buyProductGstRate').value = gst;
            document.getElementById('buyProductName').innerText = name;
            document.getElementById('buyProductDesc').innerText = desc;
            document.getElementById('buyProductStockDisplay').innerText = stock;
            document.getElementById('buyGstPercentDisplay').innerText = gst;
            document.getElementById('buyQuantity').value = 1;
            updateTotal(); 
            new bootstrap.Modal(document.getElementById('buyProductModal')).show();
        }

        function updateTotal() {
            const price = parseFloat(document.getElementById('buyProductPrice').value) || 0;
            const gstRate = parseFloat(document.getElementById('buyProductGstRate').value) || 0;
            const qty = parseInt(document.getElementById('buyQuantity').value) || 0;
            const base = price * qty;
            const gst = base * (gstRate / 100);
            document.getElementById('buyBasePrice').innerText = `₹${base.toFixed(2)}`;
            document.getElementById('buyGstAmount').innerText = `₹${gst.toFixed(2)}`;
            document.getElementById('buyTotalPrice').innerText = `₹${(base + gst).toFixed(2)}`;
        }

        document.getElementById('buyQuantity').addEventListener('input', updateTotal);

        async function deleteProduct(id) { if (confirm("Are you sure?")) { await fetch(`${API_URL}/${id}`, { method: "DELETE", headers: { "UserRole": loggedInUser.role } }); loadProducts(); } }
        function showStatus(msg) { const s = document.getElementById("successMessage"); s.innerText = msg; s.style.display = "block"; setTimeout(() => s.style.display = "none", 3000); }
        
        loadProducts();
    </script>
</body>
</html>