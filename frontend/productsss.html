<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Products - Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        /* --- MODERN UI UPDATES --- */
        .navbar {
            background-color: #ffffff !important;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }
        .navbar-brand {
            color: #2563eb !important;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .nav-link {
            color: #64748b !important;
            font-weight: 600;
            margin: 0 10px;
        }
        .nav-link.active {
            color: #2563eb !important;
        }

        .inventory-header {
            background: white;
            padding: 24px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .table-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 15px;
            border: none;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #f1f5f9;
        }

        .btn-logout {
            background-color: #fee2e2;
            color: #ef4444;
            border: none;
            font-weight: 600;
            border-radius: 8px;
        }

        #successMessage { 
            display: none; 
            position: fixed; 
            top: 80px; 
            right: 20px; 
            z-index: 10000; 
            border-radius: 12px;
            background-color: #10b981;
            color: white;
            border: none;
        }

        .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Pre-hide admin actions to prevent flickering */
        #adminActions { display: none; }

        .preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-header { cursor: move; user-select: none; border-bottom: none; }
        .modal-footer { border-top: none; }
    </style>
</head>
<body>

    <div id="preloader" class="preloader d-none">
        <div class="spinner-border text-primary"></div>
    </div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="dashboard.html"><i class="fa-solid fa-box-open me-2"></i>ERP System</a>
            <div class="collapse navbar-collapse justify-content-center">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="product.html">Products</a></li>
                    <li class="nav-item"><a class="nav-link" href="order.html">Orders</a></li>
                </ul>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="px-3 py-1 bg-light rounded-pill border">
                    <i class="fa-regular fa-circle-user me-2 text-primary"></i>
                    <span class="text-dark small fw-bold" id="profileName"></span>
                </div>
                <button class="btn btn-logout btn-sm px-3" id="logoutBtn">Logout</button>
            </div>
        </div>
    </nav>

    <div id="successMessage" class="alert alert-success shadow">Action successful!</div>

    <div class="container-fluid p-4">
        <div class="inventory-header d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
            <div>
                <h3 class="fw-bold mb-0 text-dark">Inventory Management</h3>
            </div>
            <div id="adminActions" class="gap-2">
                <button class="btn btn-primary px-4 rounded-3" data-bs-toggle="modal" data-bs-target="#addProductModal" onclick="fetchCategoriesForSelect('newCategorySelect')" id="addProductBtn">
                    <i class="bi bi-plus-lg me-2"></i>Add Product
                </button>
                <button class="btn btn-success px-4 rounded-3" data-bs-toggle="modal" data-bs-target="#addCategoryModal" id="addCategoryBtn">
                    <i class="bi bi-tag me-2"></i>Add Category
                </button>
            </div>
        </div>

        <div class="table-container">
            <div id="productContent" class="table-responsive"></div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white p-4">
                    <h5 class="modal-title fw-bold">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addProductForm">
                        <div class="mb-3"><label class="form-label fw-600">Product Name</label><input type="text" id="newName" class="form-control rounded-3" required></div>
                        <div class="mb-3"><label class="form-label fw-600">Description</label><textarea id="newDescription" class="form-control rounded-3" rows="3" required></textarea></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label fw-600">Price (₹)</label><input type="number" step="0.01" id="newPrice" class="form-control rounded-3" required></div>
                            <div class="col-6 mb-3"><label class="form-label fw-600">Stock</label><input type="number" id="newStock" class="form-control rounded-3" required></div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-600">Category</label>
                            <select id="newCategorySelect" class="form-select rounded-3" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Save Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning p-4">
                    <h5 class="modal-title fw-bold">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3"><label class="form-label">Product Name</label><input type="text" id="editName" class="form-control rounded-3" required></div>
                        <div class="mb-3"><label class="form-label">Description</label><textarea id="editDescription" class="form-control rounded-3" required></textarea></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label">Price (₹)</label><input type="number" step="0.01" id="editPrice" class="form-control rounded-3" required></div>
                            <div class="col-6 mb-3"><label class="form-label">Stock</label><input type="number" id="editStock" class="form-control rounded-3" required></div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Category</label>
                            <select id="editCategorySelect" class="form-select rounded-3" required></select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100 py-2 fw-bold text-dark">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="buyProductModal" tabindex="-1" aria-hidden="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white p-4">
                    <h5 class="modal-title fw-bold">Confirm Purchase</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="buyProductForm">
                        <input type="hidden" id="buyProductId">
                        <input type="hidden" id="buyProductPrice">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 id="buyProductName" class="fw-bold text-dark mb-1"></h5>
                                <span class="badge bg-danger rounded-pill">Stock: <span id="buyProductStockDisplay">0</span></span>
                            </div>
                            <p id="buyProductDesc" class="text-muted small"></p>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label small fw-bold">Quantity</label>
                                <input type="number" id="buyQuantity" class="form-control rounded-3" value="1" min="1" required>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label small fw-bold">Shipping Address</label>
                                <textarea id="buyAddress" class="form-control rounded-3" placeholder="Enter your full address" rows="2" required></textarea>
                            </div>
                        </div>
                        <div class="bg-light p-3 rounded-3 mb-3 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">Total Amount:</h6>
                            <h4 id="buyTotalPrice" class="text-success fw-bold mb-0">₹0.00</h4>
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold">Place Order</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white p-4">
                    <h5 class="modal-title fw-bold">Add New Category</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addCategoryForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Category Name</label>
                            <input type="text" id="catName" placeholder="e.g; Electronics" class="form-control rounded-3" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-2 fw-bold">Save Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://localhost:5112/api/products";
        const CAT_API_URL = "http://localhost:5112/api/categories";
        const ORDER_API_URL = "http://localhost:5112/api/orders";

        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

        if (!loggedInUser) {
            window.location.href = "index.html";
        } else {
            document.getElementById("profileName").innerText = loggedInUser.email;
            
            // SECURITY CHECK: Only show adminActions if role is exactly 'admin'
            if (loggedInUser.role === 'admin') {
                document.getElementById('adminActions').style.display = 'flex';
            } else {
                document.getElementById('adminActions').style.setProperty('display', 'none', 'important');
            }
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("loggedInUser");
            window.location.href = "index.html";
        });

        function makeDraggable(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const header = modal.querySelector('.modal-header');
            const dialog = modal.querySelector('.modal-dialog');

            header.onmousedown = function (e) {
                const originalWidth = dialog.offsetWidth;
                let offset = { x: e.clientX - dialog.offsetLeft, y: e.clientY - dialog.offsetTop };

                document.onmousemove = function (e) {
                    dialog.style.margin = "0";
                    dialog.style.position = "fixed";
                    dialog.style.width = originalWidth + "px";
                    dialog.style.left = (e.clientX - offset.x) + "px";
                    dialog.style.top = (e.clientY - offset.y) + "px";
                };

                document.onmouseup = function () { document.onmousemove = null; document.onmouseup = null; };
            };

            modal.addEventListener('hidden.bs.modal', () => {
                dialog.style.position = ""; dialog.style.left = ""; dialog.style.top = ""; dialog.style.margin = ""; dialog.style.width = "";
            });
        }

        ['addProductModal', 'editProductModal', 'addCategoryModal', 'buyProductModal'].forEach(id => makeDraggable(id));

        async function fetchCategoriesForSelect(selectId, selectedId = null) {
            try {
                const res = await fetch(CAT_API_URL);
                const data = await res.json();
                const categories = data.$values || data;
                let options = '<option value="">Select Category</option>';
                categories.forEach(c => {
                    options += `<option value="${c.categoryId}" ${c.categoryId == selectedId ? 'selected' : ''}>${c.name}</option>`;
                });
                document.getElementById(selectId).innerHTML = options;
            } catch (err) { console.error("Error fetching categories", err); }
        }

        async function loadProducts() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const products = data.$values || data;
                const isAdmin = loggedInUser.role === 'admin';

                let html = `<table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Category</th>
                            ${isAdmin ? '<th>Stock</th>' : ''} 
                            <th class="text-end">${isAdmin ? 'Actions' : 'Purchase'}</th>
                        </tr>
                    </thead><tbody>`;

                products.forEach(p => {
                    const safeName = p.name.replace(/'/g, "\\'");
                    const safeDesc = (p.description || "").replace(/'/g, "\\'");

                    html += `<tr>
                        <td><span class="fw-bold text-dark">${p.name}</span></td>
                        <td><small class="text-muted">${p.description}</small></td>
                        <td class="fw-bold text-primary">₹${p.price}</td>
                        <td><span class="badge bg-light text-dark border">${p.categoryName || 'N/A'}</span></td>
                        ${isAdmin ? `<td><span class="badge ${p.stock < 10 ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'}">${p.stock}</span></td>` : ''} 
                        <td class="text-end">
                            ${isAdmin ? `
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="openEditModal(${p.productId}, '${safeName}', '${safeDesc}', ${p.price}, ${p.stock}, ${p.categoryId})"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.productId})"><i class="bi bi-trash"></i></button>
                            ` : `
                                <button class="btn btn-sm btn-success px-3" onclick="openBuyModal(${p.productId}, '${safeName}', '${safeDesc}', ${p.price}, ${p.stock})">Buy Now</button>
                            `}
                        </td>
                    </tr>`;
                });
                document.getElementById("productContent").innerHTML = html + "</tbody></table>";
            } catch (err) { console.error("Error loading products", err); }
        }

        function openBuyModal(id, name, desc, price, stock) {
            document.getElementById('buyProductId').value = id;
            document.getElementById('buyProductPrice').value = price; 
            document.getElementById('buyProductName').innerText = name;
            document.getElementById('buyProductDesc').innerText = desc;
            document.getElementById('buyProductStockDisplay').innerText = stock;
            const qtyInput = document.getElementById('buyQuantity');
            qtyInput.value = 1;
            qtyInput.max = stock; 
            updateTotal(); 
            const modal = new bootstrap.Modal(document.getElementById('buyProductModal'));
            modal.show();
        }

        function updateTotal() {
            const price = parseFloat(document.getElementById('buyProductPrice').value) || 0;
            const qty = parseInt(document.getElementById('buyQuantity').value) || 0;
            const total = price * qty;
            document.getElementById('buyTotalPrice').innerText = `₹${total.toFixed(2)}`;
        }

        document.getElementById('buyQuantity').addEventListener('input', function() {
            const stock = parseInt(document.getElementById('buyProductStockDisplay').innerText) || 0;
            if (parseInt(this.value) > stock) {
                alert("No more available stock you have reached the limit!");
                this.value = stock;
            }
            updateTotal();
        });

        document.getElementById('buyProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = loggedInUser.userId || loggedInUser.id;
            const order = {
                productId: parseInt(document.getElementById('buyProductId').value),
                quantity: parseInt(document.getElementById('buyQuantity').value),
                shippingAddress: document.getElementById('buyAddress').value,
                userId: userId,
                status: "Pending"
            };
            try {
                const res = await fetch(ORDER_API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "application/json", "UserRole": loggedInUser.role },
                    body: JSON.stringify(order),
                });
                if (res.ok) {
                    showStatus("Order placed successfully!");
                    bootstrap.Modal.getInstance(document.getElementById('buyProductModal')).hide();
                    loadProducts(); 
                    document.getElementById('buyProductForm').reset();
                } else {
                    const errorData = await res.json();
                    showStatus("Failed: " + (errorData.message || "Server error"));
                }
            } catch (err) { showStatus("Error connecting to server."); }
        });

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const product = {
                name: document.getElementById('newName').value,
                description: document.getElementById('newDescription').value,
                price: parseFloat(document.getElementById('newPrice').value),
                stock: parseInt(document.getElementById('newStock').value),
                categoryId: parseInt(document.getElementById('newCategorySelect').value)
            };
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "UserRole": loggedInUser.role },
                body: JSON.stringify(product)
            });
            if (res.ok) { 
                showStatus("Product Added!");
                loadProducts();
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                document.getElementById('addProductForm').reset();
            }
        });

        function openEditModal(id, name, desc, price, stock, catId) {
            document.getElementById('editProductId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editDescription').value = desc;
            document.getElementById('editPrice').value = price;
            document.getElementById('editStock').value = stock;
            fetchCategoriesForSelect('editCategorySelect', catId);
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }

        document.getElementById('editProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editProductId').value;
            const product = {
                productId: parseInt(id),
                name: document.getElementById('editName').value,
                description: document.getElementById('editDescription').value,
                price: parseFloat(document.getElementById('editPrice').value),
                stock: parseInt(document.getElementById('editStock').value),
                categoryId: parseInt(document.getElementById('editCategorySelect').value)
            };
            const res = await fetch(`${API_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json", "UserRole": loggedInUser.role },
                body: JSON.stringify(product)
            });
            if (res.ok) { 
                showStatus("Product Updated!");
                loadProducts();
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            }
        });

        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = { name: document.getElementById('catName').value };
            const res = await fetch(CAT_API_URL, { 
                method: "POST", 
                headers: { "Content-Type": "application/json", "UserRole": loggedInUser.role },
                body: JSON.stringify(category) 
            });
            if(res.ok) { 
                showStatus("Category Added!");
                document.getElementById('addCategoryForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            }
        });

        async function deleteProduct(id) {
            if (!confirm("Are you sure?")) return;
            const res = await fetch(`${API_URL}/${id}`, {
                method: "DELETE",
                headers: { "UserRole": loggedInUser.role }
            });
            if(res.ok) { showStatus("Product Deleted!"); loadProducts(); }
        }

        function showStatus(msg) {
            const status = document.getElementById("successMessage");
            status.innerText = msg;
            status.style.display = "block";
            setTimeout(() => { status.style.display = "none"; }, 3000);
        }

        loadProducts();
    </script>
</body>
</html>